diff -Nur -x '*.orig' -x '*~' gnome-control-center-2.24.0.1/capplets/keyboard/gnome-keyboard-properties.glade gnome-control-center-2.24.0.1.new/capplets/keyboard/gnome-keyboard-properties.glade
--- gnome-control-center-2.24.0.1/capplets/keyboard/gnome-keyboard-properties.glade	2008-09-29 11:10:14.000000000 +0200
+++ gnome-control-center-2.24.0.1.new/capplets/keyboard/gnome-keyboard-properties.glade	2008-09-29 11:10:19.000000000 +0200
@@ -364,7 +364,7 @@
                   </widget>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label1">
+                  <widget class="GtkLabel" id="label2">
                     <property name="visible">True</property>
                     <property name="label" translatable="yes">General</property>
                     <property name="justify">GTK_JUSTIFY_CENTER</property>
@@ -461,96 +461,218 @@
                           </widget>
                         </child>
                         <child>
-                          <widget class="GtkCheckButton" id="chk_separate_group_per_window">
+                          <widget class="GtkVBox" id="vbox4">
                             <property name="visible">True</property>
-                            <property name="can_focus">True</property>
-                            <property name="label" translatable="yes">Separate _layout for each window</property>
-                            <property name="use_underline">True</property>
-                            <property name="response_id">0</property>
-                            <property name="draw_indicator">True</property>
-                          </widget>
-                          <packing>
-                            <property name="expand">False</property>
-                            <property name="fill">False</property>
-                            <property name="position">1</property>
-                          </packing>
-                        </child>
-                        <child>
-                          <widget class="GtkHBox" id="hbox2">
-                            <property name="visible">True</property>
-                            <property name="events">GDK_POINTER_MOTION_MASK | GDK_POINTER_MOTION_HINT_MASK | GDK_BUTTON_PRESS_MASK | GDK_BUTTON_RELEASE_MASK</property>
-                            <property name="spacing">6</property>
+                            <property name="spacing">12</property>
+                            <property name="homogeneous">True</property>
                             <child>
-                              <widget class="GtkHButtonBox" id="hbuttonbox2">
+                              <widget class="GtkHBox" id="hbox2">
                                 <property name="visible">True</property>
+                                <property name="events">GDK_POINTER_MOTION_MASK | GDK_POINTER_MOTION_HINT_MASK | GDK_BUTTON_PRESS_MASK | GDK_BUTTON_RELEASE_MASK</property>
                                 <property name="spacing">6</property>
-                                <property name="layout_style">GTK_BUTTONBOX_START</property>
                                 <child>
-                                  <widget class="GtkButton" id="xkb_layouts_remove">
+                                  <widget class="GtkButton" id="xkb_layouts_add">
                                     <property name="visible">True</property>
                                     <property name="can_focus">True</property>
-                                    <property name="label">gtk-remove</property>
-                                    <property name="use_stock">True</property>
                                     <property name="response_id">0</property>
+                                    <child>
+                                      <widget class="GtkImage" id="image2">
+                                        <property name="visible">True</property>
+                                        <property name="stock">gtk-add</property>
+                                      </widget>
+                                    </child>
                                   </widget>
                                   <packing>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
-                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                                 <child>
-                                  <widget class="GtkButton" id="xkb_layouts_print">
+                                  <widget class="GtkButton" id="xkb_layouts_remove">
                                     <property name="visible">True</property>
                                     <property name="can_focus">True</property>
-                                    <property name="label">gtk-print</property>
-                                    <property name="use_stock">True</property>
                                     <property name="response_id">0</property>
+                                    <child>
+                                      <widget class="GtkImage" id="image1">
+                                        <property name="visible">True</property>
+                                        <property name="stock">gtk-remove</property>
+                                      </widget>
+                                    </child>
                                   </widget>
                                   <packing>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
+                                    <property name="position">1</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkHButtonBox" id="hbuttonbox4">
+                                    <property name="visible">True</property>
+                                    <property name="layout_style">GTK_BUTTONBOX_END</property>
+                                    <child>
+                                      <widget class="GtkButton" id="xkb_layouts_print">
+                                        <property name="visible">True</property>
+                                        <property name="can_focus">True</property>
+                                        <property name="response_id">0</property>
+                                        <child>
+                                          <widget class="GtkAlignment" id="alignment5">
+                                            <property name="visible">True</property>
+                                            <property name="left_padding">12</property>
+                                            <property name="right_padding">12</property>
+                                            <child>
+                                              <widget class="GtkHBox" id="hbox5">
+                                                <property name="visible">True</property>
+                                                <property name="spacing">6</property>
+                                                <child>
+                                                  <widget class="GtkImage" id="image3">
+                                                    <property name="visible">True</property>
+                                                    <property name="stock">gtk-print</property>
+                                                  </widget>
+                                                </child>
+                                                <child>
+                                                  <widget class="GtkLabel" id="label11">
+                                                    <property name="visible">True</property>
+                                                    <property name="label" translatable="yes">_Print Layout Diagram...</property>
+                                                    <property name="use_underline">True</property>
+                                                  </widget>
+                                                  <packing>
+                                                    <property name="position">1</property>
+                                                  </packing>
+                                                </child>
+                                              </widget>
+                                            </child>
+                                          </widget>
+                                        </child>
+                                      </widget>
+                                      <packing>
+                                        <property name="expand">False</property>
+                                        <property name="fill">False</property>
+                                        <property name="pack_type">GTK_PACK_END</property>
+                                      </packing>
+                                    </child>
+                                  </widget>
+                                  <packing>
                                     <property name="position">2</property>
                                   </packing>
                                 </child>
+                              </widget>
+                              <packing>
+                                <property name="expand">False</property>
+                                <property name="fill">False</property>
+                              </packing>
+                            </child>
+                            <child>
+                              <widget class="GtkHBox" id="hbox3">
+                                <property name="visible">True</property>
+                                <property name="spacing">6</property>
                                 <child>
-                                  <widget class="GtkButton" id="xkb_layouts_add">
+                                  <widget class="GtkCheckButton" id="chk_separate_group_per_window">
                                     <property name="visible">True</property>
                                     <property name="can_focus">True</property>
-                                    <property name="label" translatable="yes">_Add...</property>
+                                    <property name="label" translatable="yes">Separate _layout for each window</property>
                                     <property name="use_underline">True</property>
                                     <property name="response_id">0</property>
+                                    <property name="draw_indicator">True</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="expand">False</property>
+                                    <property name="fill">False</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkButton" id="xkb_layout_options">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="receives_default">True</property>
+                                    <property name="events">GDK_POINTER_MOTION_MASK | GDK_POINTER_MOTION_HINT_MASK | GDK_BUTTON_PRESS_MASK | GDK_BUTTON_RELEASE_MASK</property>
+                                    <property name="response_id">0</property>
+                                    <child>
+                                      <widget class="GtkHBox" id="hbox6">
+                                        <property name="visible">True</property>
+                                        <child>
+                                          <widget class="GtkAlignment" id="alignment3">
+                                            <property name="visible">True</property>
+                                            <property name="left_padding">8</property>
+                                            <property name="right_padding">8</property>
+                                            <child>
+                                              <widget class="GtkLabel" id="label14">
+                                                <property name="height_request">24</property>
+                                                <property name="visible">True</property>
+                                                <property name="label" translatable="yes">Other Options...</property>
+                                              </widget>
+                                            </child>
+                                          </widget>
+                                        </child>
+                                      </widget>
+                                    </child>
                                   </widget>
                                   <packing>
                                     <property name="expand">False</property>
                                     <property name="fill">False</property>
-                                    <property name="position">3</property>
+                                    <property name="pack_type">GTK_PACK_END</property>
+                                    <property name="position">1</property>
                                   </packing>
                                 </child>
                               </widget>
                               <packing>
                                 <property name="expand">False</property>
+                                <property name="position">1</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkButton" id="xkb_reset_to_defaults">
+                              <widget class="GtkHBox" id="hbox4">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Reset to De_faults</property>
-                                <property name="use_underline">True</property>
-                                <property name="response_id">0</property>
+                                <property name="spacing">12</property>
+                                <child>
+                                  <widget class="GtkHButtonBox" id="hbuttonbox2">
+                                    <property name="visible">True</property>
+                                    <property name="spacing">6</property>
+                                    <property name="layout_style">GTK_BUTTONBOX_START</property>
+                                    <child>
+                                      <widget class="GtkButton" id="button_make_default">
+                                        <property name="visible">True</property>
+                                        <property name="can_focus">True</property>
+                                        <property name="receives_default">True</property>
+                                        <property name="response_id">0</property>
+                                        <child>
+                                          <widget class="GtkAlignment" id="alignment4">
+                                            <property name="visible">True</property>
+                                            <property name="left_padding">4</property>
+                                            <property name="right_padding">4</property>
+                                            <child>
+                                              <widget class="GtkLabel" id="label15">
+                                                <property name="visible">True</property>
+                                                <property name="label" translatable="yes">Apply System-Wide...</property>
+                                              </widget>
+                                            </child>
+                                          </widget>
+                                        </child>
+                                      </widget>
+                                    </child>
+                                    <child>
+                                      <widget class="GtkButton" id="xkb_reset_to_defaults">
+                                        <property name="visible">True</property>
+                                        <property name="can_focus">True</property>
+                                        <property name="label" translatable="yes">_Reset</property>
+                                        <property name="use_underline">True</property>
+                                        <property name="response_id">0</property>
+                                      </widget>
+                                      <packing>
+                                        <property name="position">1</property>
+                                      </packing>
+                                    </child>
+                                  </widget>
+                                </child>
                               </widget>
                               <packing>
                                 <property name="expand">False</property>
-                                <property name="fill">False</property>
-                                <property name="pack_type">GTK_PACK_END</property>
-                                <property name="position">4</property>
+                                <property name="position">2</property>
                               </packing>
                             </child>
                           </widget>
                           <packing>
                             <property name="expand">False</property>
-                            <property name="position">2</property>
+                            <property name="position">1</property>
                           </packing>
                         </child>
                       </widget>
@@ -558,28 +680,6 @@
                         <property name="position">1</property>
                       </packing>
                     </child>
-                    <child>
-                      <widget class="GtkHButtonBox" id="hbuttonbox3">
-                        <property name="visible">True</property>
-                        <property name="events">GDK_POINTER_MOTION_MASK | GDK_POINTER_MOTION_HINT_MASK | GDK_BUTTON_PRESS_MASK | GDK_BUTTON_RELEASE_MASK</property>
-                        <property name="layout_style">GTK_BUTTONBOX_END</property>
-                        <child>
-                          <widget class="GtkButton" id="xkb_layout_options">
-                            <property name="visible">True</property>
-                            <property name="can_focus">True</property>
-                            <property name="receives_default">True</property>
-                            <property name="events">GDK_POINTER_MOTION_MASK | GDK_POINTER_MOTION_HINT_MASK | GDK_BUTTON_PRESS_MASK | GDK_BUTTON_RELEASE_MASK</property>
-                            <property name="label" translatable="yes">Layout _Options...</property>
-                            <property name="use_underline">True</property>
-                            <property name="response_id">0</property>
-                          </widget>
-                        </child>
-                      </widget>
-                      <packing>
-                        <property name="expand">False</property>
-                        <property name="position">2</property>
-                      </packing>
-                    </child>
                   </widget>
                   <packing>
                     <property name="position">1</property>
@@ -1897,7 +1997,7 @@
                     <property name="visible">True</property>
                     <property name="spacing">6</property>
                     <child>
-                      <widget class="GtkLabel" id="label2">
+                      <widget class="GtkLabel" id="label10">
                         <property name="visible">True</property>
                         <property name="xalign">0</property>
                         <property name="label" translatable="yes">Preview:</property>
@@ -1967,7 +2067,7 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkButton" id="btnOk">
+              <widget class="GtkButton" id="btnOk1">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
                 <property name="can_default">True</property>
diff -Nur -x '*.orig' -x '*~' gnome-control-center-2.24.0.1/capplets/keyboard/gnome-keyboard-properties-xkb.c gnome-control-center-2.24.0.1.new/capplets/keyboard/gnome-keyboard-properties-xkb.c
--- gnome-control-center-2.24.0.1/capplets/keyboard/gnome-keyboard-properties-xkb.c	2008-09-29 11:10:14.000000000 +0200
+++ gnome-control-center-2.24.0.1.new/capplets/keyboard/gnome-keyboard-properties-xkb.c	2008-09-29 11:19:57.000000000 +0200
@@ -29,6 +29,7 @@
 #include <gdk/gdkx.h>
 #include <gconf/gconf-client.h>
 #include <glade/glade.h>
+#include <dbus/dbus-glib.h>
 
 #include "capplet-util.h"
 #include "gconf-property-editor.h"
@@ -122,6 +123,154 @@
 	xkb_gconf_client = NULL;
 }
 
+// mvo: make default entry the system wide default
+static void
+make_default (GtkWidget * button, GladeXML * dialog)
+{
+        GkbdKeyboardConfig kbd;
+	GError *error = NULL;
+	gboolean dbus_ret, res;
+	DBusGConnection *systembus, *sessionbus;
+	DBusGProxy *dbus_proxy;
+	int default_group;
+	gchar model[128] = {0,};
+	gchar layout[128] = {0,};
+	gchar variant[128] = {0,};
+	gchar options[256] = {0,};
+
+	// get current settings
+	gkbd_keyboard_config_init (&kbd, xkb_gconf_client, engine);
+	gkbd_keyboard_config_load_from_gconf (&kbd, &initial_config);
+	default_group = gconf_client_get_int(xkb_gconf_client, 
+					     "/desktop/gnome/peripherals/keyboard/general/defaultGroup",
+					     NULL);
+
+	// convert so that its apprioriate for the dbus backend
+	strncpy(model, kbd.model, sizeof(model));
+
+	// get default_group
+	gchar *ndata = (gchar*)g_list_nth_data((GSList*)kbd.layouts_variants, default_group);
+	// something is wrong with the gconf settings, ignore
+	if(ndata == NULL) {
+	   g_printerr("gconf default keyboard group out of range\n");
+	   return;
+	}
+	gchar** layout_variant = g_strsplit(ndata, "\t", -1);
+	strncpy(layout, layout_variant[0], sizeof(layout));
+	if(g_strv_length(layout_variant) > 1)
+	   strncpy(variant, layout_variant[1], sizeof(variant));
+	g_strfreev(layout_variant);
+
+	// build options string
+	GString *options_str = g_string_new("");
+	GSList *l = kbd.options;
+	if (l && l->data) {
+	   gchar** options_v = g_strsplit(l->data,"\t",-1);
+	   options_str = g_string_append(options_str, options_v[1]);
+	   g_strfreev(options_v);
+	}
+	while(l = g_list_next(l)) {
+	   options_str = g_string_append(options_str, ",");
+	   gchar** options_v = g_strsplit(l->data,"\t",-1);
+	   options_str = g_string_append(options_str, options_v[1]);
+	   g_strfreev(options_v);
+	}
+	strncpy(options, options_str->str, sizeof(options));
+	g_string_free(options_str, TRUE);
+	gkbd_keyboard_config_term (&kbd);
+
+	// the console does not deal very well with evdev, we let
+	// the auto detection handle this for now
+	if (strcmp(model,"evdev") == 0)
+	   strcpy(model,"");
+
+#if 0	
+	printf("model: %s\n", model);
+	printf("layout: '%s'\n", layout);
+	printf("variant: '%s'\n", variant);
+	printf("options: '%s'\n", options);
+#endif
+
+	// now do the dbus stuff
+	sessionbus = dbus_g_bus_get (DBUS_BUS_SESSION, &error);
+	if (sessionbus == NULL) {
+	   g_printerr ("Failed to open connection to bus: %s\n",
+		       error->message);
+	   g_error_free (error);
+	   return;
+	}
+
+	dbus_proxy = dbus_g_proxy_new_for_name (sessionbus,
+						"org.freedesktop.PolicyKit.AuthenticationAgent",
+						"/",
+						"org.freedesktop.PolicyKit.AuthenticationAgent");
+	if (dbus_proxy == NULL) {
+	   g_printerr ("Failed to get proxy: %s\n",
+                  error->message);
+	   g_error_free (error);
+	   return;
+	}
+
+	if (!dbus_g_proxy_call (dbus_proxy, "ObtainAuthorization", &error, 
+				G_TYPE_STRING, "com.ubuntu.systemservice.setkeyboard",			   
+				G_TYPE_UINT, 0,
+				G_TYPE_UINT, getpid(),
+				G_TYPE_INVALID,
+				G_TYPE_BOOLEAN, &res, G_TYPE_INVALID))
+	   {
+	      if (error->domain == DBUS_GERROR && 
+		  error->code == DBUS_GERROR_REMOTE_EXCEPTION)
+		 g_printerr ("Caught remote method exception %s: %s",
+			     dbus_g_error_get_name (error),
+			     error->message);
+	      else
+		 g_printerr ("Error: %s\n", error->message);
+	      g_error_free (error);
+	      return;
+	   }
+	g_object_unref (dbus_proxy);
+	g_print("ObtainAuth returned: %i\n", res);
+	// so we get a "0" here too if the auth is not required ?!?
+	//   if(!res)
+	//   return;
+   
+	systembus = dbus_g_bus_get (DBUS_BUS_SYSTEM, &error);
+	dbus_proxy = dbus_g_proxy_new_for_name (systembus,
+						"com.ubuntu.SystemService",
+						"/",
+						"com.ubuntu.SystemService");
+	if (dbus_proxy == NULL) {
+	   g_printerr ("Failed to get dbus proxy: %s\n",
+		       error->message);
+	   g_error_free (error);
+	   return;
+	}
+
+	dbus_ret = dbus_g_proxy_call (dbus_proxy, "set_keyboard", &error, 
+				      G_TYPE_STRING, model,
+				      G_TYPE_STRING, layout,
+				      G_TYPE_STRING, variant,
+				      G_TYPE_STRING, options,
+				      G_TYPE_INVALID,
+				      G_TYPE_BOOLEAN, &res, 
+				      G_TYPE_INVALID);
+	if (!dbus_ret) {
+	      if (error->domain == DBUS_GERROR && 
+		  error->code == DBUS_GERROR_REMOTE_EXCEPTION)
+		 g_printerr ("Caught remote method exception %s: %s",
+			     dbus_g_error_get_name (error),
+			     error->message);
+	      else
+		 g_printerr ("Error: %s\n", error->message);
+	      g_error_free (error);
+	      return;
+	}
+
+
+	//printf("res: %i\n", res);
+	g_object_unref (dbus_proxy);
+}
+
 static void
 reset_to_defaults (GtkWidget * button, GladeXML * dialog)
 {
@@ -182,6 +331,11 @@
 			  "clicked", G_CALLBACK (reset_to_defaults),
 			  dialog);
 
+	// mvo: global keyboard setting
+	g_signal_connect (G_OBJECT (WID ("button_make_default")),
+			  "clicked", G_CALLBACK (make_default),
+			  dialog);
+
 	g_signal_connect_swapped (G_OBJECT (WID ("xkb_layout_options")),
 				  "clicked",
 				  G_CALLBACK (xkb_options_popup_dialog),
