From: Mathieu Trudel-Lapierre <mathieu.trudel-lapierre@canonical.com>
Subject: Provide a way to show/hide nm-applet from the menu panel.

Index: gnome-control-center-3.3.90/panels/network/cc-network-panel.c
===================================================================
--- gnome-control-center-3.3.90.orig/panels/network/cc-network-panel.c	2012-02-22 09:33:14.259926679 -0500
+++ gnome-control-center-3.3.90/panels/network/cc-network-panel.c	2012-02-22 09:35:21.911920987 -0500
@@ -27,6 +27,7 @@
 #include <unistd.h>
 #include <gio/gio.h>
 #include <gdesktop-enums.h>
+#include <gconf/gconf-client.h>
 
 #include "cc-network-panel.h"
 
@@ -62,6 +63,8 @@
 #define NETWORK_PANEL_PRIVATE(o) \
         (G_TYPE_INSTANCE_GET_PRIVATE ((o), CC_TYPE_NETWORK_PANEL, CcNetworkPanelPrivate))
 
+#define NM_APPLET_SHOW_APPLET_GCONF_KEY "/apps/nm-applet/show-applet"
+
 typedef enum {
         OPERATION_NULL,
         OPERATION_SHOW_DEVICE,
@@ -75,6 +78,7 @@
 {
         GCancellable     *cancellable;
         GSettings        *proxy_settings;
+        GConfClient      *gconf_client;
         GtkBuilder       *builder;
         NMClient         *client;
         NMRemoteSettings *remote_settings;
@@ -193,6 +197,10 @@
                 g_object_unref (priv->proxy_settings);
                 priv->proxy_settings = NULL;
         }
+        if (priv->gconf_client) {
+                g_object_unref (priv->gconf_client);
+                priv->gconf_client = NULL;
+        }
         if (priv->cancellable != NULL) {
                 g_cancellable_cancel (priv->cancellable);
                 g_object_unref (priv->cancellable);
@@ -3485,6 +3493,19 @@
 }
 
 static void
+applet_show_toggled (GtkWidget *widget, CcNetworkPanel *panel)
+{
+        gboolean visible;
+
+        visible = gtk_toggle_button_get_active (GTK_TOGGLE_BUTTON (widget));
+
+        gconf_client_set_bool (panel->priv->gconf_client,
+                               NM_APPLET_SHOW_APPLET_GCONF_KEY,
+                               visible,
+                               NULL);
+}
+
+static void
 cc_network_panel_init (CcNetworkPanel *panel)
 {
         DBusGConnection *bus = NULL;
@@ -3499,6 +3520,7 @@
         GtkTreeSortable *sortable;
         GtkWidget *widget;
         GtkWidget *toplevel;
+        gboolean visible;
 
         panel->priv = NETWORK_PANEL_PRIVATE (panel);
 
@@ -3774,6 +3796,19 @@
         toplevel = gtk_widget_get_toplevel (GTK_WIDGET (panel));
         g_signal_connect_after (toplevel, "map", G_CALLBACK (on_toplevel_map), panel);
 
+        /* add the show/hide checkbox to toggle displaying nm-applet in the panel */
+        widget = GTK_WIDGET (gtk_builder_get_object (panel->priv->builder,
+                                                     "checkbutton_show_applet"));
+
+        panel->priv->gconf_client = gconf_client_get_default ();
+        visible = gconf_client_get_bool (panel->priv->gconf_client,
+                                         NM_APPLET_SHOW_APPLET_GCONF_KEY,
+                                         NULL);
+        gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (widget), visible);
+        g_signal_connect (widget, "toggled",
+                          G_CALLBACK (applet_show_toggled),
+                          panel);
+
         /* hide implementation details */
         widget = GTK_WIDGET (gtk_builder_get_object (panel->priv->builder,
                                                      "notebook_types"));
Index: gnome-control-center-3.3.90/panels/network/network.ui
===================================================================
--- gnome-control-center-3.3.90.orig/panels/network/network.ui	2012-02-22 09:33:14.263926680 -0500
+++ gnome-control-center-3.3.90/panels/network/network.ui	2012-02-22 09:34:30.423923282 -0500
@@ -246,7 +246,6 @@
                     <property name="can_focus">False</property>
                     <property name="margin_left">12</property>
                     <property name="margin_top">12</property>
-                    <property name="margin_bottom">12</property>
                     <child>
                       <object class="GtkScrolledWindow" id="devices_scrolledwindow">
                         <property name="visible">True</property>
@@ -2376,6 +2375,38 @@
             <property name="position">0</property>
           </packing>
         </child>
+        <child>
+          <object class="GtkBox" id="box_show_applet">
+            <property name="visible">True</property>
+            <property name="can_focus">False</property>
+            <property name="margin_left">12</property>
+            <property name="margin_right">12</property>
+            <property name="margin_bottom">12</property>
+            <child>
+              <object class="GtkCheckButton" id="checkbutton_show_applet">
+                <property name="label" translatable="yes">_Show Network status in the menu bar</property>
+                <property name="use_action_appearance">False</property>
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="receives_default">False</property>
+                <property name="use_action_appearance">False</property>
+                <property name="use_underline">True</property>
+                <property name="xalign">0</property>
+                <property name="draw_indicator">True</property>
+              </object>
+              <packing>
+                <property name="expand">False</property>
+                <property name="fill">True</property>
+                <property name="position">0</property>
+              </packing>
+            </child>
+          </object>
+          <packing>
+            <property name="expand">False</property>
+            <property name="fill">True</property>
+            <property name="position">1</property>
+          </packing>
+        </child>
       </object>
     </child>
   </object>
Index: gnome-control-center-3.3.90/configure.ac
===================================================================
--- gnome-control-center-3.3.90.orig/configure.ac	2012-02-22 09:33:14.755926653 -0500
+++ gnome-control-center-3.3.90/configure.ac	2012-02-22 09:33:14.787926655 -0500
@@ -116,7 +116,7 @@
 PKG_CHECK_MODULES(MEDIA_PANEL, $COMMON_MODULES)
 PKG_CHECK_MODULES(MOUSE_PANEL, $COMMON_MODULES xi >= 1.2
                   gnome-settings-daemon >= $GSD_REQUIRED_VERSION x11)
-PKG_CHECK_MODULES(NETWORK_PANEL, $COMMON_MODULES)
+PKG_CHECK_MODULES(NETWORK_PANEL, $COMMON_MODULES gconf-2.0)
 PKG_CHECK_MODULES(ONLINE_ACCOUNTS_PANEL, $COMMON_MODULES goa-1.0 goa-backend-1.0)
 PKG_CHECK_MODULES(POWER_PANEL, $COMMON_MODULES upower-glib >= 0.9.1
                   gnome-settings-daemon >= $GSD_REQUIRED_VERSION)
