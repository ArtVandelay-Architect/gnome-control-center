From 82e6777cb1a32edb9c85b85c0c3768f9ca62c4c2 Mon Sep 17 00:00:00 2001
From: Marco Barisione <marco.barisione@collabora.co.uk>
Date: Wed, 21 Aug 2013 11:48:25 +0100
Subject: [PATCH] online-accounts: use the async function to get all the
 providers

https://bugzilla.gnome.org/show_bug.cgi?id=706148
---
 panels/online-accounts/cc-online-accounts-panel.c | 49 ++++++++++++++++++-----
 1 file changed, 40 insertions(+), 9 deletions(-)

--- a/panels/online-accounts/cc-online-accounts-panel.c
+++ b/panels/online-accounts/cc-online-accounts-panel.c
@@ -669,11 +669,19 @@
 
 /* ---------------------------------------------------------------------------------------------------- */
 
+typedef struct
+{
+  CcGoaPanel *panel;
+  GoaProvider *provider;
+  GVariant *preseed;
+} AddAccountData;
+
 static void
-add_account (CcGoaPanel *panel,
-             GoaProvider *provider,
-             GVariant *preseed)
+get_all_providers_cb (GObject      *source,
+                      GAsyncResult *res,
+                      gpointer      user_data)
 {
+  AddAccountData *data = user_data;
   GtkWindow *parent;
   GtkWidget *dialog;
   GList *providers;
@@ -681,12 +689,15 @@
   GoaObject *object;
   GError *error;
 
-  parent = GTK_WINDOW (cc_shell_get_toplevel (cc_panel_get_shell (CC_PANEL (panel))));
+  providers = NULL;
+  if (!goa_provider_get_all_finish (&providers, res, NULL))
+    goto out;
+
+  parent = GTK_WINDOW (cc_shell_get_toplevel (cc_panel_get_shell (CC_PANEL (data->panel))));
 
-  dialog = goa_panel_add_account_dialog_new (panel->client);
+  dialog = goa_panel_add_account_dialog_new (data->panel->client);
   gtk_window_set_transient_for (GTK_WINDOW (dialog), parent);
 
-  providers = goa_provider_get_all ();
   for (l = providers; l != NULL; l = l->next)
     {
       GoaProvider *provider;
@@ -696,7 +707,7 @@
     }
 
   goa_panel_add_account_dialog_set_preseed_data (GOA_PANEL_ADD_ACCOUNT_DIALOG (dialog),
-                                                 provider, preseed);
+                                                 data->provider, data->preseed);
 
   gtk_widget_show_all (dialog);
   goa_panel_add_account_dialog_run (GOA_PANEL_ADD_ACCOUNT_DIALOG (dialog));
@@ -713,11 +724,11 @@
     {
       GtkTreeIter iter;
       /* navigate to newly created object */
-      if (goa_panel_accounts_model_get_iter_for_object (panel->accounts_model,
+      if (goa_panel_accounts_model_get_iter_for_object (data->panel->accounts_model,
                                                         object,
                                                         &iter))
         {
-          gtk_tree_selection_select_iter (gtk_tree_view_get_selection (GTK_TREE_VIEW (panel->accounts_treeview)),
+          gtk_tree_selection_select_iter (gtk_tree_view_get_selection (GTK_TREE_VIEW (data->panel->accounts_treeview)),
                                           &iter);
         }
       g_object_unref (object);
@@ -742,9 +753,28 @@
       g_error_free (error);
     }
 
- out:
   g_list_foreach (providers, (GFunc) g_object_unref, NULL);
   g_list_free (providers);
+
+out:
+  g_clear_object (&data->panel);
+  g_clear_object (&data->provider);
+  g_clear_pointer (&data->preseed, g_variant_unref);
+  g_slice_free (AddAccountData, data);
+}
+
+static void
+add_account (CcGoaPanel *panel,
+             GoaProvider *provider,
+             GVariant *preseed)
+{
+  AddAccountData *data;
+
+  data = g_slice_new0 (AddAccountData);
+  data->panel = g_object_ref_sink (panel);
+  data->provider = (provider != NULL ? g_object_ref (provider) : NULL);
+  data->preseed = (preseed != NULL ? g_variant_ref (preseed) : NULL);
+  goa_provider_get_all (get_all_providers_cb, data);
 }
 
 /* ---------------------------------------------------------------------------------------------------- */
