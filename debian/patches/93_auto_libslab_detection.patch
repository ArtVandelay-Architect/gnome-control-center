From 2710afbe26c447da39b742ee2f95fe4f59e3c161 Mon Sep 17 00:00:00 2001
From: Vincent Untz <vuntz@gnome.org>
Date: Tue, 11 Aug 2009 12:11:58 +0200
Subject: [PATCH] Use external libslab when available

diff -Nur -x '*.orig' -x '*~' gnome-control-center-2.27.5/configure.in gnome-control-center-2.27.5.new/configure.in
--- gnome-control-center-2.27.5/configure.in	2009-08-11 22:19:46.999216457 +0100
+++ gnome-control-center-2.27.5.new/configure.in	2009-08-11 22:21:35.264216597 +0100
@@ -112,16 +112,28 @@
 dnl
 dnl Check dependencies of libslab
 dnl
-PKG_CHECK_MODULES(LIBSLAB, [
-			   gio-2.0 gnome-desktop-2.0 librsvg-2.0 libgnome-menu pango gconf-2.0
-			   ],
-			   have_libslab_deps=yes,
-			   have_libslab_deps=no)
-WARN_CFLAGS="-Wall"
+PKG_CHECK_MODULES(EXTERNAL_LIBSLAB, [libslab], have_libslab=yes, have_libslab=no)
+
+if test $have_libslab = no; then
+	PKG_CHECK_MODULES(LIBSLAB, [
+				   gio-2.0 gnome-desktop-2.0 librsvg-2.0 libgnome-menu pango gconf-2.0
+				   ],
+				   have_libslab_deps=yes,
+				   have_libslab_deps=no)
+	WARN_CFLAGS="-Wall"
+else
+	have_libslab_deps=no
+fi
+
+AC_SUBST(EXTERNAL_LIBSLAB_CFLAGS)
+AC_SUBST(EXTERNAL_LIBSLAB_LIBS)
 AC_SUBST(LIBSLAB_CFLAGS)
 AC_SUBST(LIBSLAB_LIBS)
 AC_SUBST(WARN_CFLAGS)
+
+AM_CONDITIONAL(HAVE_LIBSLAB, [test $have_libslab = yes -o $have_libslab_deps = yes])
 AM_CONDITIONAL(HAVE_LIBSLAB_DEPS, [test $have_libslab_deps = yes])
+AM_CONDITIONAL(LIBSLAB_FOR_INTERNAL_USE, test "yes" = "yes")
 
 # When copying libslab, make sure to change this to match the value specified
 # in libslab's configure.ac file
diff -Nur -x '*.orig' -x '*~' gnome-control-center-2.27.5/Makefile.am gnome-control-center-2.27.5.new/Makefile.am
--- gnome-control-center-2.27.5/Makefile.am	2009-08-11 22:19:43.488211063 +0100
+++ gnome-control-center-2.27.5.new/Makefile.am	2009-08-11 22:19:49.736213799 +0100
@@ -1,7 +1,11 @@
 SUBDIRS = po libwindow-settings capplets font-viewer help
 
 if HAVE_LIBSLAB_DEPS
-SUBDIRS += libslab shell
+SUBDIRS += libslab
+endif
+
+if HAVE_LIBSLAB
+SUBDIRS += shell
 endif
 
 if HAVE_TYPING_BREAK
diff -Nur -x '*.orig' -x '*~' gnome-control-center-2.27.5/shell/Makefile.am gnome-control-center-2.27.5.new/shell/Makefile.am
--- gnome-control-center-2.27.5/shell/Makefile.am	2009-08-11 22:19:43.204218303 +0100
+++ gnome-control-center-2.27.5.new/shell/Makefile.am	2009-08-11 22:19:49.736213799 +0100
@@ -1,5 +1,13 @@
+if HAVE_LIBSLAB_DEPS
+REAL_LIBSLAB_CFLAGS = -I$(top_srcdir)/libslab
+REAL_LIBSLAB_LIBS = $(top_builddir)/libslab/libslab.la
+else
+REAL_LIBSLAB_CFLAGS = $(EXTERNAL_LIBSLAB_CFLAGS)
+REAL_LIBSLAB_LIBS = $(EXTERNAL_LIBSLAB_LIBS)
+endif
+
 INCLUDES =					\
-	-I$(top_srcdir)/libslab			\
+	$(REAL_LIBSLAB_CFLAGS)			\
 	$(GNOMECC_SHELL_CFLAGS)
 
 bin_PROGRAMS = gnome-control-center 
@@ -9,7 +17,7 @@
 
 gnome_control_center_LDADD =						\
 	$(GNOMECC_SHELL_LIBS)						\
-	$(top_builddir)/libslab/libslab.la
+	$(REAL_LIBSLAB_LIBS)
 
 AM_CPPFLAGS =							\
 	-DGNOMELOCALEDIR="\"$(datadir)/locale\""
