From 2710afbe26c447da39b742ee2f95fe4f59e3c161 Mon Sep 17 00:00:00 2001
From: Vincent Untz <vuntz@gnome.org>
Date: Tue, 11 Aug 2009 12:11:58 +0200
Subject: [PATCH] Use external libslab when available

---
 Makefile.am       |    6 +++++-
 configure.in      |   25 ++++++++++++++++++-------
 shell/Makefile.am |   12 ++++++++++--
 3 files changed, 33 insertions(+), 10 deletions(-)

--- a/Makefile.am
+++ b/Makefile.am
@@ -2,7 +2,11 @@
 DIST_SUBDIRS = po libwindow-settings capplets font-viewer help libslab shell typing-break
 
 if HAVE_LIBSLAB_DEPS
-SUBDIRS += libslab shell
+SUBDIRS += libslab
+endif
+
+if HAVE_LIBSLAB
+SUBDIRS += shell
 endif
 
 if HAVE_TYPING_BREAK
--- a/configure.in
+++ b/configure.in
@@ -112,17 +112,28 @@
 dnl
 dnl Check dependencies of libslab
 dnl
-PKG_CHECK_MODULES(LIBSLAB, [
-			   gio-2.0 gnome-desktop-2.0 librsvg-2.0 libgnome-menu pango gconf-2.0
-			   ],
-			   have_libslab_deps=yes,
-			   have_libslab_deps=no)
-WARN_CFLAGS="-Wall"
+PKG_CHECK_MODULES(EXTERNAL_LIBSLAB, [libslab], have_libslab=yes, have_libslab=no)
+
+if test $have_libslab = no; then
+	PKG_CHECK_MODULES(LIBSLAB, [
+				   gio-2.0 gnome-desktop-2.0 librsvg-2.0 libgnome-menu pango gconf-2.0
+				   ],
+				   have_libslab_deps=yes,
+				   have_libslab_deps=no)
+	WARN_CFLAGS="-Wall"
+else
+	have_libslab_deps=no
+fi
+
+AC_SUBST(EXTERNAL_LIBSLAB_CFLAGS)
+AC_SUBST(EXTERNAL_LIBSLAB_LIBS)
 AC_SUBST(LIBSLAB_CFLAGS)
 AC_SUBST(LIBSLAB_LIBS)
 AC_SUBST(WARN_CFLAGS)
-AM_CONDITIONAL(LIBSLAB_FOR_INTERNAL_USE, test "yes" = "yes")
+
+AM_CONDITIONAL(HAVE_LIBSLAB, [test $have_libslab = yes -o $have_libslab_deps = yes])
 AM_CONDITIONAL(HAVE_LIBSLAB_DEPS, [test $have_libslab_deps = yes])
+AM_CONDITIONAL(LIBSLAB_FOR_INTERNAL_USE, test "yes" = "yes")
 
 dnl
 dnl Check for Xft version 2; we build in extra functionality to the font capplet
--- a/shell/Makefile.am
+++ b/shell/Makefile.am
@@ -1,6 +1,14 @@
+if HAVE_LIBSLAB_DEPS
+REAL_LIBSLAB_CFLAGS = -I$(top_srcdir)/libslab
+REAL_LIBSLAB_LIBS = $(top_builddir)/libslab/libslab.la
+else
+REAL_LIBSLAB_CFLAGS = $(EXTERNAL_LIBSLAB_CFLAGS)
+REAL_LIBSLAB_LIBS = $(EXTERNAL_LIBSLAB_LIBS)
+endif
+
 INCLUDES =					\
 	-I$(top_srcdir)				\
-	-I$(top_srcdir)/libslab			\
+	$(REAL_LIBSLAB_CFLAGS)			\
 	$(GNOMECC_SHELL_CFLAGS)
 
 bin_PROGRAMS = gnome-control-center 
@@ -10,7 +18,7 @@
 
 gnome_control_center_LDADD =						\
 	$(GNOMECC_SHELL_LIBS)						\
-	$(top_builddir)/libslab/libslab.la
+	$(REAL_LIBSLAB_LIBS)
 
 AM_CPPFLAGS =							\
 	-DGNOMELOCALEDIR="\"$(datadir)/locale\""
